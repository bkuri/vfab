# Maintainer: Bernardo Kuri <github@bkuri.com>
pkgname=plotty
pkgver=1.0.1
pkgrel=1
pkgdesc="ploTTY: FSM plotter manager (headless-first) with vpype + per-session recording"
arch=('any')
url="https://github.com/bkuri/plotty"
license=('MIT')
depends=(
  'python>=3.11'
  'python-typer'
  'python-pydantic'
  'python-yaml'
  'python-sqlalchemy'
  'python-alembic'
  'python-rich'
  'python-jinja'
  'python-psutil'
  'python-click'
  'python-platformdirs'
  'python-defusedxml'
)
makedepends=(
  'python-build'
  'python-installer'
  'python-wheel'
  'python-setuptools'
)
optdepends=(
  'python-pyaxidraw: AxiDraw plotter support (install from PyPI)'
  'vpype: SVG optimization and processing (install from PyPI)'
  'ffmpeg: Camera recording and timelapse generation'
  'python-pillow: Image processing for reports'
  'python-matplotlib: Plot generation for statistics'
  'python-pandas: Data analysis for statistics'
)
checkdepends=(
  'python-pytest'
  'python-pytest-cov'
)
provides=('plotty')
conflicts=('plotty')
source=("$pkgname-$pkgver.tar.gz::https://github.com/bkuri/plotty/archive/refs/tags/v$pkgver.tar.gz")
sha256sums=('dac3b03be3873d45411b615163ad0c5be01da9e638c4c0ad6e5052a056b18726')

build() {
  cd "$pkgname-$pkgver"
  python -m build --wheel --no-isolation
}

check() {
  cd "$pkgname-$pkgver"
  local python_version=$(python -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
  
  # Install test dependencies
  pip install pytest pytest-cov
  
  # Run tests
  PYTHONPATH="$PWD/src" pytest tests/ -v
}

package() {
  cd "$pkgname-$pkgver"
  python -m installer --destdir="$pkgdir" dist/*.whl
  
  # Install documentation
  install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
  install -Dm644 CHANGELOG.md "$pkgdir/usr/share/doc/$pkgname/CHANGELOG.md"
  install -Dm644 docs/requirements/v1.md "$pkgdir/usr/share/doc/$pkgname/REQUIREMENTS.md"
  
  # Install license
  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  
  # Install systemd service files
  install -Dm644 packaging/systemd/plottyd.service "$pkgdir/usr/lib/systemd/user/plottyd.service"
  install -Dm644 packaging/quadlet/plottyd.container "$pkgdir/usr/share/containers/systemd/plottyd.container"
  
  # Install shell completions
  install -Dm644 completions/bash/plotty "$pkgdir/usr/share/bash-completion/completions/plotty"
  install -Dm644 completions/zsh/_plotty "$pkgdir/usr/share/zsh/site-functions/_plotty"
  install -Dm644 completions/fish/plotty.fish "$pkgdir/usr/share/fish/vendor_completions.d/plotty.fish"
}

post_install() {
  echo "ploTTY v$pkgver has been installed successfully!"
  echo ""
  echo "User data will be stored in: ~/.local/share/plotty/"
  echo "Configuration: ~/.config/plotty/config.yaml"
  echo ""
  echo "Quick start:"
  echo "  plotty setup                    # Run setup wizard"
  echo "  plotty job add drawing.svg      # Add a job"
  echo "  plotty job plan drawing        # Plan the job"
  echo "  plotty plot drawing            # Plot the job"
  echo ""
  echo "For AxiDraw support:"
  echo "  pip install pyaxidraw"
  echo "  plotty plot drawing --device axidraw"
  echo ""
  echo "For statistics:"
  echo "  plotty stats summary           # View statistics"
  echo "  (Database automatically initialized on first run)"
  echo ""
  echo "Documentation: /usr/share/doc/$pkgname/"
}

post_upgrade() {
  echo "ploTTY has been upgraded to v$pkgver"
  echo "Run 'uv run alembic upgrade head' to update the database schema"
}

pre_remove() {
  echo "Removing ploTTY..."
  echo "Your user data directory (~/.local/share/plotty/) will not be removed."
}
