# Maintainer: Bernardo Kuri <github@bkuri.com>
pkgname=plotty
pkgver=1.2.2
pkgrel=1
pkgdesc="ploTTY: FSM plotter manager (headless-first) with vpype + per-session recording"
arch=('any')
url="https://github.com/bkuri/plotty"
license=('MIT')
depends=(
  'python>=3.13'
  'python-typer'
  'python-pydantic'
  'python-yaml'
  'python-sqlalchemy'
  'python-alembic'
  'python-rich'
  'python-jinja'
  'python-psutil'
  'python-click'
  'python-platformdirs'
  'python-defusedxml'
  'ffmpeg'
  'python-pillow'
  'python-matplotlib'
  'python-pandas'
  'python-pipx'
)
makedepends=(
  'python-build'
  'python-installer'
  'python-wheel'
  'python-setuptools'
)
optdepends=(
  'python-pyaxidraw: AxiDraw plotter support (install from PyPI)'
  'ffmpeg: Camera recording and timelapse generation'
  'python-pillow: Image processing for reports'
  'python-matplotlib: Plot generation for statistics'
  'python-pandas: Data analysis for statistics'
)
checkdepends=(
  'python-pytest'
  'python-pytest-cov'
)
provides=('plotty')
conflicts=('plotty')
source=("$pkgname-$pkgver.tar.gz::https://github.com/bkuri/plotty/archive/refs/tags/v$pkgver.tar.gz")
sha256sums=('19052c3b549fa349fbab56c4f4a9ad8a2c75b8b7e476f5f334749ca49e139a6e')

build() {
  cd "$pkgname-$pkgver"
  python -m build --wheel --no-isolation
}

check() {
  cd "$pkgname-$pkgver"
  
  # Basic import test to verify package installation
  python -c "
import sys
sys.path.insert(0, 'src')
try:
    import plotty
    print('✓ ploTTY imports successfully')
    from plotty.config import load_config
    print('✓ Config module loads')
    from plotty.fsm import JobFSM
    print('✓ FSM module loads')
    print('✓ All basic imports working')
except Exception as e:
    print(f'✗ Import failed: {e}')
    sys.exit(1)
"
}

package() {
  cd "$pkgname-$pkgver"
  python -m installer --destdir="$pkgdir" dist/*.whl
  
  # Install documentation
  install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
  install -Dm644 CHANGELOG.md "$pkgdir/usr/share/doc/$pkgname/CHANGELOG.md"
  
  # Install license
  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  
  # Install systemd service files
  install -Dm644 packaging/systemd/plottyd.service "$pkgdir/usr/lib/systemd/user/plottyd.service"
  install -Dm644 packaging/quadlet/plottyd.container "$pkgdir/usr/share/containers/systemd/plottyd.container"
  
  # Install shell completions
  install -Dm644 completions/bash/plotty "$pkgdir/usr/share/bash-completion/completions/plotty"
  install -Dm644 completions/zsh/_plotty "$pkgdir/usr/share/zsh/site-functions/_plotty"
  install -Dm644 completions/fish/plotty.fish "$pkgdir/usr/share/fish/vendor_completions.d/plotty.fish"
}

post_install() {
  echo "ploTTY v$pkgver has been installed successfully!"
  echo ""
  echo "User data will be stored in: ~/.local/share/plotty/"
  echo "Configuration: ~/.config/plotty/config.yaml"
  echo ""
  echo "Quick start:"
  echo "  plotty setup                    # Run setup wizard"
  echo "  plotty job add drawing.svg      # Add a job"
  echo "  plotty job plan drawing        # Plan the job"
  echo "  plotty plot drawing            # Plot the job"
  echo ""
  echo "Optional dependencies:"
  echo "  plotty install-axidraw          # Install pyaxidraw for AxiDraw support"
  echo "  pipx install \"vpype[all]\"       # Install vpype for SVG processing"
  echo ""
  echo "For statistics:"
  echo "  plotty stats summary           # View statistics"
  echo "  (Database automatically initialized on first run)"
  echo ""
  echo "Documentation: /usr/share/doc/$pkgname/"
}

post_upgrade() {
  echo "ploTTY has been upgraded to v$pkgver"
  echo "Run 'uv run alembic upgrade head' to update the database schema"
}

pre_remove() {
  echo "Removing ploTTY..."
  echo "Your user data directory (~/.local/share/plotty/) will not be removed."
}
