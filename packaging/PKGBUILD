# Maintainer: Bernardo Kuri <github+vfab@bkuri.com>
pkgname=vfab
pkgver=0.9.0
pkgrel=1
pkgdesc="FSM plotter manager (headless-first) with vpype + per-session recording"
arch=('any')
url="https://github.com/bkuri/$pkgname"
license=('MIT')

depends=(
  'python>=3.13'
  'python-typer'
  'python-pydantic'
  'python-yaml'
  'python-sqlalchemy'
  'python-alembic'
  'python-rich'
  'python-jinja'
  'python-psutil'
  'python-click'
  'python-platformdirs'
  'python-defusedxml'
  'ffmpeg'
  'python-pillow'
  'python-matplotlib'
  'python-pandas'
  'python-pipx'
)

makedepends=(
  'python-build'
  'python-installer'
  'python-wheel'
  'python-setuptools'
)

optdepends=(
  'python-pyaxidraw: AxiDraw plotter support (install from PyPI)'
  'ffmpeg: Camera recording and timelapse generation'
  'python-pillow: Image processing for reports'
  'python-matplotlib: Plot generation for statistics'
  'python-pandas: Data analysis for statistics'
)

checkdepends=(
  'python-pytest'
  'python-pytest-cov'
)

provides=('vfab')
conflicts=('vfab')
source=("$url/releases/download/v$pkgver/$pkgname-$pkgver.tar.gz")
# Note: Update sha256sum when new GitHub release is created
sha256sums=('507663bac0d8620072c0c0ccee26fa1b1d25795b518cd94a5f274f4dee4c643e')

build() {
  cd "$pkgname-$pkgver"
  python -m build --wheel --no-isolation
  
  # Create entry point script for testing
  mkdir -p "$srcdir/entry_test"
  cat > "$srcdir/entry_test/$pkgname" << 'EOF'
#!/usr/bin/python3
import sys
from vfab.cli import main
sys.exit(main())
EOF
  chmod +x "$srcdir/entry_test/$pkgname"
}

check() {
  cd "$pkgname-$pkgver"
  
  # Test basic imports from the built wheel
  python -c "
import sys
sys.path.insert(0, 'src')
try:
    import vfab
    print('✓ vfab imports successfully')
    from vfab.config import load_config
    print('✓ Config module loads')
    from vfab.fsm import JobFSM
    print('✓ FSM module loads')
    print('✓ All basic imports working')
except Exception as e:
    print(f'✗ Import failed: {e}')
    sys.exit(1)
"
  
  # Test entry point script structure
  if [ -f "$srcdir/entry_test/$pkgname" ]; then
    echo "✓ Entry point script created successfully"
    grep -q "from $pkgname.cli import main" "$srcdir/entry_test/$pkgname" && echo "✓ Entry point has correct import" || echo "✗ Entry point import incorrect"
  else
    echo "✗ Entry point script not created"
    return 1
  fi
}

package() {
  cd "$pkgname-$pkgver"
  
  # Find the built wheel file (handles dynamic versioning)
  local wheel_file
  wheel_file=$(find dist -name "*.whl" -type f | head -n1)

  if [ -z "$wheel_file" ]; then
    echo "Error: No wheel file found in dist/"
    return 1
  fi
  
  echo "Installing wheel: $wheel_file"
  python -m installer --destdir="$pkgdir" --prefix=/usr "$wheel_file"
  
  # Create proper entry point script
  cat > "$pkgdir/usr/bin/$pkgname" << 'EOF'
#!/usr/bin/python3
import sys
from vfab.cli import main
sys.exit(main())
EOF

  chmod +x "$pkgdir/usr/bin/$pkgname"
  
  # Install documentation
  install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
  install -Dm644 CHANGELOG.md "$pkgdir/usr/share/doc/$pkgname/CHANGELOG.md"
  
  # Install license
  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  
  # Install systemd service files
  install -Dm644 "packaging/systemd/$pkgname.service" "$pkgdir/usr/lib/systemd/user/$pkgname.service"
  install -Dm644 "packaging/quadlet/$pkgname.container" "$pkgdir/usr/share/containers/systemd/$pkgname.container"
  
  # Install shell completions
  install -Dm644 "completions/bash/$pkgname" "$pkgdir/usr/share/bash-completion/completions/$pkgname"
  install -Dm644 "completions/zsh/_$pkgname" "$pkgdir/usr/share/zsh/site-functions/_$pkgname"
  install -Dm644 "completions/fish/$pkgname.fish" "$pkgdir/usr/share/fish/vendor_completions.d/$pkgname.fish"
}

post_install() {
  echo "vfab v$pkgver has been installed successfully!"
  echo ""
  echo "User data will be stored in: ~/.local/share/$pkgname/"
  echo "Configuration: ~/.config/$pkgname/config.yaml"
  echo ""
  echo "Quick start:"
  echo "  $pkgname setup                   # Run setup wizard"
  echo "  $pkgname job add drawing.svg     # Add a job"
  echo "  $pkgname job plan drawing        # Plan the job"
  echo "  $pkgname plot drawing            # Plot the job"
  echo ""
  echo "Optional dependencies:"
  echo "  $pkgname install-axidraw         # Install pyaxidraw for AxiDraw support"
  echo "  pipx install vpype[all]          # Install vpype for SVG processing"
  echo ""
  echo "For statistics:"
  echo "  $pkgname stats summary           # View statistics"
  echo "  (Database automatically initialized on first run)"
  echo ""
  echo "Documentation: /usr/share/doc/$pkgname/"
}

post_upgrade() {
  echo "$pkgname has been upgraded to v$pkgver"
  echo "Run 'uv run alembic upgrade head' to update the database schema"
}

pre_remove() {
  echo "Removing $pkgname…"
  echo "Your user data directory (~/.local/share/$pkgname/) will not be removed."
}
